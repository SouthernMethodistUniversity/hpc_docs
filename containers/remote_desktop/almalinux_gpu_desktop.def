Bootstrap: docker
From: almalinux:9

%labels
    Author Amit Kumar <ahkumar@smu.edu>, Richard England <rengland@smu.edu>
    Version v1.0
    Framework Open OnDemand
    Distribution CentOS 7
    Application Combined Desktops

%environment
  export PATH=/opt/TurboVNC/bin:/opt/VirtualGL/bin:${PATH}

%post
    dnf update -y --refresh
    dnf install -y dnf-plugin-config-manager
    dnf install -y almalinux-release-nvidia-driver
    dnf install -y nvidia-open nvidia-driver-cuda cuda
    dnf config-manager --add-repo https://raw.githubusercontent.com/VirtualGL/repo/main/VirtualGL.repo
    dnf config-manager --add-repo https://raw.githubusercontent.com/VirtualGL/repo/main/VirtualGL-i386.repo
    dnf config-manager --add-repo https://raw.githubusercontent.com/TurboVNC/repo/main/TurboVNC.repo
    gpg --list-keys
    dnf install -y epel-release
    dnf -y install yum-utils
    dnf -y install dbus
    dnf -y install zsh
    dnf -y install tcsh
    dnf	-y install ksh
    dnf -y install xorg-x11-utils
    dnf -y install xorg-x11-xauth
    dnf -y groupinstall 'Base'
    dnf -y groupinstall 'Infiniband Support'
    dnf groupinstall -y 'Xfce'
    dnf -y groupinstall 'Legacy UNIX Compatibility'
    dnf -y groupinstall 'Network File System Client'
    dnf -y install evince eog
    dnf -y install gedit
    dnf -y install emacs
    dnf -y install glibc glibc-common libgcc libstdc++
    dnf -y install Lmod.x86_64
    dnf -y install libXp.x86_64
    dnf -y install VirtualGL.x86_64
    dnf -y install VirtualGL.i386
    dnf -y install turbovnc
    dnf --enablerepo=epel -y install novnc python3-websockify python3-numpy
    dnf -y install glx-utils
    dnf -y install systemd-libs
    dnf -y install gdm gnome-tweak-tool gnome-shell-extension-top-icons gnome-shell-extension-systemMonitor gnome-shell-extension-user-theme
    dnf -y install sssd
    dnf install -y  xorg-x11-server-Xorg
    dnf -y groupinstall 'Development Tools'
    dnf -y install kernel-devel kmod
    dnf -y install libnsl
    dnf -y install lua lua-posix
    dnf -y install libXScrnSaver
    dnf -y install pcre2-devel
    dnf -y install libX11-xcb xcb-util libxcb libxcb-devel xcb-util-cursor-devel xcb-util-wm xcb-util-keysyms xcb-util-renderutil
    dnf -y install libXrender libXrandr libXcursor
    dnf -y install libxcrypt-compat
    ln -fs /usr/share/zoneinfo/America/Chicago /etc/localtime
    
    echo "/usr/lib64/gtk-2.0/modules" >/etc/ld.so.conf.d/gtk2.conf
    ldconfig

    # try to get modules working
    ln -s /usr/bin/lua /usr/bin/lua5.3
    ln -s /usr/share/lua/5.4 /usr/share/lua/5.3
    mkdir -p /usr/lib/lua
    ln -s /usr/lib64/lua/5.4 /usr/lib/lua/5.3

    # stop error in terminal
    touch /usr/bin/locale-check
    chmod +x /usr/bin/locale-check

    dnf clean all -y
    rm -rf /var/cache/dnf/*
    rm -rf /etc/ld.so.cache
    rm -rf /var/cache/ldconfig/*
